<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>티비몬</title>

  <!-- Android용: manifest -->
  <link rel="manifest" href="/braveFilters/manifest.json">

  <!-- iOS용: 아이콘 & 이름 -->
  <link rel="apple-touch-icon" href="/braveFilters/icons/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Brave Filters">

  <style>
    /* Google Fonts에서 Noto Sans KR 폰트 가져오기 */
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');

    :root {
      --bg-color: #1a1a1a;
      --primary-color: #2a2a2a;
      --secondary-color: #3a3a3a;
      --accent-color: #007bff;
      --text-color: #e0e0e0;
      --border-radius: 12px;
      --box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      --transition-speed: 0.3s;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      width: 100%;
      max-width: 400px;
      background-color: var(--primary-color);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 30px;
      text-align: center;
      border: 1px solid var(--secondary-color);
    }

    header h1 { font-size: 24px; font-weight: 700; margin-bottom: 10px; }
    header p { font-size: 14px; color: #a0a0a0; margin-bottom: 30px; }

    .button-group { display: flex; gap: 15px; margin-bottom: 25px; }

    .btn {
      flex: 1;
      padding: 15px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-speed) ease;
      color: #fff;
      background-color: var(--accent-color);
      letter-spacing: 0.5px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 123, 255, 0.2);
      filter: brightness(1.1);
    }

    .btn-tvmon { background: linear-gradient(45deg, #28a745, #218838); }
    .btn-tvmon:hover { box-shadow: 0 6px 20px rgba(40, 167, 69, 0.2); }

    .btn-zzapflix { background: linear-gradient(45deg, #dc3545, #c82333); }
    .btn-zzapflix:hover { box-shadow: 0 6px 20px rgba(220, 53, 69, 0.2); }

    .status-box {
      background-color: var(--secondary-color);
      border-radius: 8px;
      padding: 20px;
      min-height: 100px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transition: background-color var(--transition-speed) ease;
    }

    .status-message {
      font-size: 15px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .loader {
      width: 16px;
      height: 16px;
      border: 2px solid #fff;
      border-bottom-color: transparent;
      border-radius: 50%;
      display: none; /* Initially hidden */
      animation: rotation 1s linear infinite;
    }

    @keyframes rotation {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .btn-cancel {
      background-color: #6c757d;
      padding: 8px 20px;
      display: none; /* Initially hidden */
    }
    .btn-cancel:hover { background-color: #5a6268; }
  </style>
</head>
<body>

  <div class="container">
    <header>
      <h1>바로가기 도우미</h1>
      <p>원하는 사이트 버튼을 클릭하세요.</p>
    </header>

    <div class="button-group">
      <button class="btn btn-tvmon" id="tvmonBtn">티비몬</button>
      <button class="btn btn-zzapflix" id="zzapflixBtn">짭플릭스</button>
    </div>

    <div class="status-box">
      <div id="statusMessage" class="status-message">
        <div id="loader" class="loader"></div>
        <span id="statusText">대기 중...</span>
      </div>
      <button class="btn btn-cancel" id="cancelBtn">취소</button>
    </div>
  </div>

  <script>
    const tvmonBtn = document.getElementById('tvmonBtn');
    const zzapflixBtn = document.getElementById('zzapflixBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const statusText = document.getElementById('statusText');
    const loader = document.getElementById('loader');

    let abortController;
    let timeoutId;

    // 공통: 상태 표시
    const updateStatus = (message, isLoading = false) => {
      statusText.textContent = message;
      loader.style.display = isLoading ? 'inline-block' : 'none';
      cancelBtn.style.display = isLoading ? 'block' : 'none';
    };

    // 공통: 타임아웃 적용 fetch
    const fetchWithTimeout = (url, options = {}, ms = 10000) => {
      const controller = new AbortController();
      const { signal } = controller;
      const merged = { ...options, signal };

      // 외부에서 취소 가능하도록 최신 controller 보관
      abortController = controller;

      // 타임아웃
      timeoutId = setTimeout(() => controller.abort(), ms);
      return fetch(url, merged).finally(() => clearTimeout(timeoutId));
    };

    // 대상 사이트 설정
    const sites = {
      tvmon: {
        name: "티비몬",
        // 요구사항: 항상 tvmon.site로 바로 이동
        directUrl: "https://tvmon.site/"
      },
      zzapflix: {
        name: "짭플릭스",
        // CORS 프록시로 링크 모음 페이지를 가져옴
        fetchUrl: "https://api.allorigins.win/raw?url=https://linkchak.com/index.html",
        // 정규식: http/https 모두 허용, 숫자 캡처 (예: https://zzap171.com/)
        pattern: /^https?:\/\/zzap(\d+)\.com\/?$/i,
        // ✅ 루트로만 이동 (경로/쿼리 제거)
        buildUrl: (base) => {
          const u = new URL(base);
          u.pathname = "/";
          u.search = "";
          u.hash = "";
          return u.toString();
        }
      }
    };

    // 티비몬: 단순 이동
    const goTvmon = () => {
      updateStatus("티비몬으로 이동합니다...", true);
      // 약간의 UX 지연(로더 표시) 후 이동
      setTimeout(() => {
        window.location.href = sites.tvmon.directUrl;
      }, 300);
    };

    // 짭플릭스: 최신 주소(최대 숫자) 선택 후 루트로 이동
    const goZzapflix = async () => {
      try {
        updateStatus("짭플릭스 사이트에 접속 중...", true);

        const response = await fetchWithTimeout(sites.zzapflix.fetchUrl, {}, 10000);
        if (!response.ok) throw new Error(`HTTP 에러! 상태: ${response.status}`);

        updateStatus("최신 주소를 찾는 중...", true);
        const html = await response.text();

        // 1차: DOM 파싱 후 a 태그 href에서 검색
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");
        const links = Array.from(doc.querySelectorAll("a"));

        const candidates = [];

        for (const a of links) {
          const val = a.href || "";
          const m = val.match(sites.zzapflix.pattern);
          if (m) candidates.push({ num: parseInt(m[1], 10), url: m[0] });
        }

        // 2차(백업): a 태그에서 못 찾으면 HTML 전체 문자열에서 정규식 매치
        if (candidates.length === 0) {
          const re = new RegExp(sites.zzapflix.pattern, "gi");
          let m;
          while ((m = re.exec(html)) !== null) {
            candidates.push({ num: parseInt(m[1], 10), url: m[0] });
          }
        }

        if (candidates.length > 0) {
          // 숫자 최댓값(최신) 선택
          candidates.sort((a, b) => b.num - a.num);
          const newest = candidates[0].url.replace(/^http:/i, "https:"); // http 나오면 https로 통일
          const finalUrl = sites.zzapflix.buildUrl(newest.endsWith("/") ? newest : newest + "/");
          updateStatus("최신 주소를 찾았습니다. 이동합니다!");
          window.location.href = finalUrl;
        } else {
          updateStatus("유효한 짭플릭스 주소를 찾지 못했습니다.", false);
        }
      } catch (error) {
        if (error.name === "AbortError") {
          updateStatus("작업이 사용자에 의해 취소되었습니다.", false);
        } else {
          console.error("오류 발생:", error);
          updateStatus("오류가 발생했습니다. 다시 시도해주세요.", false);
        }
      }
    };

    // 이벤트 바인딩
    tvmonBtn.addEventListener("click", goTvmon);
    zzapflixBtn.addEventListener("click", goZzapflix);

    cancelBtn.addEventListener("click", () => {
      try {
        if (abortController) abortController.abort();
        if (timeoutId) clearTimeout(timeoutId);
      } finally {
        updateStatus("작업이 취소되었습니다.", false);
      }
    });
  </script>

</body>
</html>
